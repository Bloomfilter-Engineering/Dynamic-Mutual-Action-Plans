<!-- dynamicActionPlanBuilder.html -->
<template>
    <div class="slds-card">
        <!-- Header -->
        <div class="slds-card__header slds-grid">
            <div class="slds-media slds-media_center slds-has-flexi-truncate">
                <div class="slds-media__body">
                    <h2 class="slds-text-heading_small">
                        Create Your Action Plan
                    </h2>
                </div>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="slds-p-horizontal_medium">
            <div class="slds-progress">
                <ol class="slds-progress__list">
                    <li class={step1Class}>
                        <div class="slds-progress__marker"></div>
                        <div class="slds-progress__item_content">Your Information</div>
                    </li>
                    <li class={step2Class}>
                        <div class="slds-progress__marker"></div>
                        <div class="slds-progress__item_content">Add Tasks</div>
                    </li>
                    <li class={step3Class}>
                        <div class="slds-progress__marker"></div>
                        <div class="slds-progress__item_content">Review</div>
                    </li>
                    <li class={step4Class}>
                        <div class="slds-progress__marker"></div>
                        <div class="slds-progress__item_content">Complete</div>
                    </li>
                </ol>
                <div class="slds-progress-bar">
                    <span class="slds-progress-bar__value" style={progressBarStyle}></span>
                </div>
            </div>
        </div>
        
        <!-- Loading Spinner -->
        <template if:true={isLoading}>
            <div class="slds-align_absolute-center slds-p-around_large">
                <lightning-spinner alternative-text="Loading" size="large"></lightning-spinner>
            </div>
        </template>
        
        <!-- Step 1: User Information -->
        <template if:true={isStep1}>
            <div class="slds-card__body slds-p-around_medium">
                <div class="slds-text-longform">
                    <p class="slds-m-bottom_medium">
                        Please provide your contact information to create your personalized action plan.
                    </p>
                </div>
                
                <div class="slds-form" role="list">
                    <div class="slds-form__row">
                        <div class="slds-form__item" role="listitem">
                            <div class="slds-form-element slds-form-element_stacked">
                                <label class="slds-form-element__label" for="email">
                                    <abbr class="slds-required" title="required">* </abbr>Email Address
                                </label>
                                <div class="slds-form-element__control">
                                    <input type="email" 
                                           id="email"
                                           class="slds-input" 
                                           placeholder="your.email@example.com"
                                           data-field="email"
                                           value={userInfo.email}
                                           onchange={handleUserInfoChange}
                                           required />
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="slds-form__row">
                        <div class="slds-form__item" role="listitem">
                            <div class="slds-form-element slds-form-element_stacked">
                                <label class="slds-form-element__label" for="name">
                                    <abbr class="slds-required" title="required">* </abbr>Full Name
                                </label>
                                <div class="slds-form-element__control">
                                    <input type="text" 
                                           id="name"
                                           class="slds-input" 
                                           placeholder="John Doe"
                                           data-field="name"
                                           value={userInfo.name}
                                           onchange={handleUserInfoChange}
                                           required />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>
        
        <!-- Step 2: Add Tasks -->
        <template if:true={isStep2}>
            <div class="slds-card__body">
                <!-- Task Templates Section -->
                <div class="slds-p-around_medium slds-border_bottom">
                    <h3 class="slds-text-heading_small slds-m-bottom_small">Quick Add Templates</h3>
                    <div class="slds-grid slds-wrap slds-gutters_small">
                        <template for:each={taskTemplates} for:item="template">
                            <div key={template.Id} class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3">
                                <article class="slds-card slds-card_boundary">
                                    <div class="slds-card__header">
                                        <h4 class="slds-text-title_caps">{template.Name}</h4>
                                    </div>
                                    <div class="slds-card__body slds-card__body_inner">
                                        <p class="slds-text-body_small">{template.Description__c}</p>
                                    </div>
                                    <div class="slds-card__footer">
                                        <button class="slds-button slds-button_neutral"
                                                data-template-id={template.Id}
                                                onclick={handleAddTemplate}>
                                            Add Template
                                        </button>
                                    </div>
                                </article>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- Custom Task Button -->
                <div class="slds-p-around_medium slds-border_bottom">
                    <button class="slds-button slds-button_brand" onclick={handleAddTask}>
                        <svg class="slds-button__icon slds-button__icon_left" aria-hidden="true">
                            <use xlink:href="/assets/icons/utility-sprite/svg/symbols.svg#add"></use>
                        </svg>
                        Add Custom Task
                    </button>
                    <span class="slds-m-left_medium slds-text-body_small">
                        {totalTasks} task(s) added
                    </span>
                </div>
                
                <!-- Task List -->
                <template if:false={hasNoTasks}>
                    <div class="slds-p-around_medium">
                        <h3 class="slds-text-heading_small slds-m-bottom_medium">Your Tasks</h3>
                        
                        <!-- Paginated Tasks -->
                        <template for:each={paginatedTasks} for:item="task">
                            <div key={task.tempId} class="slds-box slds-m-bottom_small">
                                <div class="slds-grid slds-wrap">
                                    <!-- Task Name -->
                                    <div class="slds-col slds-size_1-of-1 slds-medium-size_6-of-12 slds-p-horizontal_small">
                                        <div class="slds-form-element">
                                            <label class="slds-form-element__label">
                                                <abbr class="slds-required">* </abbr>Task Name
                                            </label>
                                            <div class="slds-form-element__control">
                                                <input type="text" 
                                                       class="slds-input"
                                                       value={task.name}
                                                       data-task-id={task.tempId}
                                                       data-field="name"
                                                       onchange={handleTaskChange}
                                                       required />
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Priority -->
                                    <div class="slds-col slds-size_1-of-1 slds-medium-size_3-of-12 slds-p-horizontal_small">
                                        <div class="slds-form-element">
                                            <label class="slds-form-element__label">Priority</label>
                                            <div class="slds-form-element__control">
                                                <select class="slds-select"
                                                        value={task.priority}
                                                        data-task-id={task.tempId}
                                                        data-field="priority"
                                                        onchange={handleTaskChange}>
                                                    <template for:each={priorityOptions} for:item="option">
                                                        <option key={option.value} value={option.value}>
                                                            {option.label}
                                                        </option>
                                                    </template>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Days After Start -->
                                    <div class="slds-col slds-size_1-of-1 slds-medium-size_3-of-12 slds-p-horizontal_small">
                                        <div class="slds-form-element">
                                            <label class="slds-form-element__label">Days from Start</label>
                                            <div class="slds-form-element__control">
                                                <input type="number" 
                                                       class="slds-input"
                                                       value={task.daysAfterStart}
                                                       min="0"
                                                       max="365"
                                                       data-task-id={task.tempId}
                                                       data-field="daysAfterStart"
                                                       onchange={handleTaskChange} />
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Description -->
                                    <div class="slds-col slds-size_1-of-1 slds-p-horizontal_small slds-m-top_small">
                                        <div class="slds-form-element">
                                            <label class="slds-form-element__label">Description</label>
                                            <div class="slds-form-element__control">
                                                <textarea class="slds-textarea"
                                                          value={task.description}
                                                          rows="2"
                                                          data-task-id={task.tempId}
                                                          data-field="description"
                                                          onchange={handleTaskChange}></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Category -->
                                    <div class="slds-col slds-size_1-of-1 slds-medium-size_4-of-12 slds-p-horizontal_small slds-m-top_small">
                                        <div class="slds-form-element">
                                            <label class="slds-form-element__label">Category</label>
                                            <div class="slds-form-element__control">
                                                <select class="slds-select"
                                                        value={task.category}
                                                        data-task-id={task.tempId}
                                                        data-field="category"
                                                        onchange={handleTaskChange}>
                                                    <template for:each={categoryOptions} for:item="option">
                                                        <option key={option.value} value={option.value}>
                                                            {option.label}
                                                        </option>
                                                    </template>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Assigned To -->
                                    <div class="slds-col slds-size_1-of-1 slds-medium-size_5-of-12 slds-p-horizontal_small slds-m-top_small">
                                        <div class="slds-form-element">
                                            <label class="slds-form-element__label">Assigned To (Email)</label>
                                            <div class="slds-form-element__control">
                                                <input type="email" 
                                                       class="slds-input"
                                                       value={task.assignedToEmail}
                                                       placeholder="assignee@example.com"
                                                       data-task-id={task.tempId}
                                                       data-field="assignedToEmail"
                                                       onchange={handleTaskChange} />
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Is Required -->
                                    <div class="slds-col slds-size_1-of-1 slds-medium-size_3-of-12 slds-p-horizontal_small slds-m-top_small">
                                        <div class="slds-form-element">
                                            <div class="slds-form-element__control">
                                                <div class="slds-checkbox">
                                                    <input type="checkbox"
                                                           id={task.tempId}
                                                           checked={task.isRequired}
                                                           data-task-id={task.tempId}
                                                           data-field="isRequired"
                                                           onchange={handleTaskChange} />
                                                    <label class="slds-checkbox__label" for={task.tempId}>
                                                        <span class="slds-checkbox_faux"></span>
                                                        <span class="slds-form-element__label">Required Task</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Actions -->
                                    <div class="slds-col slds-size_1-of-1 slds-p-horizontal_small slds-m-top_small">
                                        <div class="slds-button-group" role="group">
                                            <button class="slds-button slds-button_neutral slds-button_small"
                                                    data-task-id={task.tempId}
                                                    onclick={handleDuplicateTask}>
                                                Duplicate
                                            </button>
                                            <button class="slds-button slds-button_text-destructive slds-button_small"
                                                    data-task-id={task.tempId}
                                                    onclick={handleRemoveTask}>
                                                Remove
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Pagination -->
                        <template if:true={totalPages}>
                            <div class="slds-m-top_medium">
                                <div class="slds-button-group" role="group">
                                    <button class="slds-button slds-button_neutral"
                                            disabled={!hasPreviousPage}
                                            onclick={handlePreviousPage}>
                                        Previous
                                    </button>
                                    <span class="slds-p-horizontal_small">
                                        Page {currentPage} of {totalPages}
                                    </span>
                                    <button class="slds-button slds-button_neutral"
                                            disabled={!hasNextPage}
                                            onclick={handleNextPage}>
                                        Next
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
                
                <!-- No Tasks Message -->
                <template if:true={hasNoTasks}>
                    <div class="slds-p-around_large slds-align_absolute-center">
                        <div class="slds-text-align_center">
                            <p class="slds-text-body_regular slds-m-bottom_medium">
                                No tasks added yet. Start by adding a template or custom task.
                            </p>
                        </div>
                    </div>
                </template>
            </div>
        </template>
        
        <!-- Step 3: Review -->
        <template if:true={isStep3}>
            <div class="slds-card__body slds-p-around_medium">
                <h3 class="slds-text-heading_small slds-m-bottom_medium">Review Your Action Plan</h3>
                
                <!-- User Information Summary -->
                <div class="slds-box slds-m-bottom_medium">
                    <h4 class="slds-text-title_caps slds-m-bottom_small">Your Information</h4>
                    <dl class="slds-list_horizontal slds-wrap">
                        <dt class="slds-item_label slds-text-color_weak">Name:</dt>
                        <dd class="slds-item_detail">{userInfo.name}</dd>
                        <dt class="slds-item_label slds-text-color_weak">Email:</dt>
                        <dd class="slds-item_detail">{userInfo.email}</dd>
                    </dl>
                </div>
                
                <!-- Tasks Summary -->
                <div class="slds-box">
                    <h4 class="slds-text-title_caps slds-m-bottom_small">
                        Tasks ({totalTasks})
                    </h4>
                    <ul class="slds-list_dotted">
                        <template for:each={tasks} for:item="task">
                            <li key={task.tempId} class="slds-m-bottom_x-small">
                                <strong>{task.name}</strong>
                                <span class="slds-badge slds-m-left_x-small">{task.priority}</span>
                                <span class="slds-m-left_small">- {task.daysAfterStart} days from start</span>
                            </li>
                        </template>
                    </ul>
                </div>
                
                <!-- Confirmation Message -->
                <div class="slds-m-top_medium">
                    <div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_info" role="alert">
                        <h2 class="slds-text-heading_small">Ready to Submit?</h2>
                        <p>Please review your information above. Once submitted, your action plan will be processed and you'll receive a tracking reference.</p>
                    </div>
                </div>
            </div>
        </template>
        
        <!-- Step 4: Complete -->
        <template if:true={isStep4}>
            <div class="slds-card__body slds-p-around_large">
                <div class="slds-align_absolute-center">
                    <div class="slds-text-align_center">
                        <div class="slds-m-bottom_medium">
                            <svg class="slds-icon slds-icon_large slds-icon-text-success" aria-hidden="true">
                                <use xlink:href="/assets/icons/utility-sprite/svg/symbols.svg#success"></use>
                            </svg>
                        </div>
                        <h2 class="slds-text-heading_medium slds-m-bottom_small">
                            Action Plan Submitted Successfully!
                        </h2>
                        <p class="slds-text-body_regular slds-m-bottom_medium">
                            Your reference number is: <strong>{completedReferenceId}</strong>
                        </p>
                        <p class="slds-text-body_small slds-m-bottom_large">
                            Please save this reference number to track your action plan status.
                        </p>
                        
                        <template if:true={trackingUrl}>
                            <div class="slds-m-bottom_medium">
                                <a href={trackingUrl} class="slds-button slds-button_brand">
                                    Track Your Action Plan
                                </a>
                            </div>
                        </template>
                        
                        <button class="slds-button slds-button_neutral" onclick={handleStartOver}>
                            Create Another Action Plan
                        </button>
                    </div>
                </div>
            </div>
        </template>
        
        <!-- Footer Navigation -->
        <template if:false={isStep4}>
            <div class="slds-card__footer">
                <div class="slds-grid slds-grid_align-spread">
                    <div>
                        <template if:false={isStep1}>
                            <button class="slds-button slds-button_neutral" 
                                    onclick={handlePrevious}>
                                Previous
                            </button>
                        </template>
                    </div>
                    <div>
                        <template if:false={isStep3}>
                            <button class="slds-button slds-button_brand"
                                    disabled={!canProceed}
                                    onclick={handleNext}>
                                Next
                            </button>
                        </template>
                        <template if:true={isStep3}>
                            <button class="slds-button slds-button_success"
                                    onclick={handleSave}
                                    disabled={isLoading}>
                                Submit Action Plan
                            </button>
                        </template>
                    </div>
                </div>
            </div>
        </template>
        
        <!-- Error Display -->
        <template if:true={error}>
            <div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_error" role="alert">
                <h2>{error}</h2>
            </div>
        </template>
    </div>
</template>